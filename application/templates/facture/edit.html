{% extends 'base.html' %}

{% block title %} {{ title_page }} {% endblock %}

{% block title_header %} {{ title_page }} {% endblock %}

{% block  button %}
    <a class="uk-button waves-effect uk-button-success uk-button-small" id="submit" href=""><span class="uk-margin-small-right"><i class="fa fa-floppy-o"></i></span>Enreg.</a>
    {% if not form.devis_id.data %}
        {% if facture_id %}
            <a class="uk-button waves-effect uk-button-danger uk-button-small" href="{{ url_for('facture.view', facture_id=facture_id, paged=request.args.get('paged')) }}"><span class="uk-margin-small-right"><i class="fa fa-times"></i></span>Annuler</a>
        {% else %}
            <a class="uk-button waves-effect uk-button-success uk-button-small" id="submit_nouveau" href=""><span class="uk-margin-small-right"><i class="fa fa-floppy-o"></i></span> et Nouveau</a>
            {% if request.args.get('dashboard') %}
                <a class="uk-button waves-effect uk-button-danger uk-button-small" href="{{ url_for('dashboard.index') }}"><span class="uk-margin-small-right"><i class="fa fa-reply"></i></span>Retour</a>
            {% else %}
            <a class="uk-button waves-effect uk-button-danger uk-button-small" href="{{ url_for('facture.index', paged=request.args.get('paged')) }}"><span class="uk-margin-small-right"><i class="fa fa-reply"></i></span>Retour</a>
                {% endif %}
        {% endif %}
    {% else %}
        {% if facture_id %}
            <a class="uk-button waves-effect uk-button-danger uk-button-small" href="{{ url_for('facture.view', facture_id=facture_id, paged=request.args.get('paged')) }}"><span class="uk-margin-small-right"><i class="fa fa-times"></i></span>Annuler</a>
        {% else %}
            <a class="uk-button waves-effect uk-button-success uk-button-small" id="submit_nouveau" href=""><span class="uk-margin-small-right"><i class="fa fa-floppy-o"></i></span> et Nouveau</a>
            <a class="uk-button waves-effect uk-button-danger uk-button-small" href="{{ url_for('devis.view', devis_id=current_devis.id, paged=request.args.get('paged')) }}"><span class="uk-margin-small-right"><i class="fa fa-reply"></i></span>Retour</a>

        {% endif %}
    {% endif %}
{% endblock %}

{% block layout_content %}
    <div class="uk-container uk-margin">
            {% include 'includes/flash_message.html' %}
            <div class="uk-grid-small" uk-grid>
                <div class="uk-width-1-1">
                    <form method="post" id="formulaire">
                        {{ form.hidden_tag() }}
                        {{ form_client.hidden_tag() }}
                        {{ form_contact.hidden_tag() }}

                        <input type="hidden" name="nouveau" value="0" id="nouveau"/>
                        <div class="uk-card uk-card-default uk-card-small uk-card-body">
                            <div class="uk-padding uk-padding-remove-horizontal uk-grid-small uk-grid-divider" uk-grid>
                                 <div class="uk-width-1-1@s">
                                    <div class="uk-margin">
                                        <label class="uk-form-label uk-text-bold">Reference : </label>
                                        <div class="uk-form-controls">
                                            <input type="text" class="uk-input uk-form-blank uk-width-1-1" {% if devis_id %} value="{{ current_ref.ref_devis }}/{{ data.ref }}" {% endif %}/>
                                        </div>
                                    </div>
                                 </div>
                                {% if form.devis_id.data or data.parent %}
                                    <div class="uk-width-1-1@s">
                                        <div class="uk-margin">
                                            {{ form.devis_text.label(class_='uk-form-label uk-text-bold') }}
                                            <div class="uk-form-controls ">
                                                <div class="uk-inline  uk-width-1-1">
                                                    {{ form.devis_text(class_='uk-input uk-form-blank') }}
                                                    <a class="uk-form-icon uk-form-icon-flip" id="print" href="{{ url_for('devis.view', devis_id=current_devis.id) }}" uk-icon="icon: link"></a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}


                                <div class="uk-width-1-2@s">
                                    <div class="uk-grid-small" uk-grid>
                                        <div class="uk-width-1-1@s">
                                            <h3 class="uk-heading-line uk-text-center"><span>Information du client</span></h3>
                                        </div>
                                    {% if form.devis_id.data or data.parent %}
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.raison.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    <ul class="uk-subnav uk-margin-small-top">
                                                        <li class="uk-active">
                                                            {% if form_client.raison.data == 'LT' %} Etablissement {% endif %}
                                                            {% if form_client.raison.data == 'SARL' %} SARL (Société à responsabilité limitée) {% endif %}
                                                            {% if form_client.raison.data == 'SA' %} SA (Société Anonyme) {% endif %}
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.name.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_client.name(class_='uk-input uk-form-blank') }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.email.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_client.email(class_='uk-input uk-form-blank') }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.phone.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_client.phone(class_='uk-input uk-form-blank') }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.ville.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_client.ville(class_='uk-input uk-form-blank') }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.quartier.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_client.quartier(class_='uk-input uk-form-blank') }}
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="uk-width-1-1@s">
                                            <div class="uk-margin">
                                                <label for="" class="uk-form-label"></label>
                                                <div class="uk-form-controls">
                                                    <select  name="client_exist" id="client_exist" class="uk-select selected">
                                                        <option value="">Selectionnez un client existant</option>
                                                        {% for client in client_list %}
                                                            <option value="{{ client.id }}" {% if form_client.id.data|string == client.id|string %} selected {% endif %}>{{ client.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.raison.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    <select name="client-raison" id="client-raison" class="uk-select selected">
                                                        <option value="">Selectionnez votre forme juridique</option>
                                                        <option value="LT" {% if form_client.raison.data == 'LT' %} selected {% endif %}>Etablissement</option>
                                                        <option value="SARL" {% if form_client.raison.data == 'SARL' %} selected {% endif %}>SARL (Société à responsabilité limitée)</option>
                                                        <option value="SA" {% if form_client.raison.data == 'SA' %} selected {% endif %}>SA (Société Anonyme)</option>
                                                    </select>
                                                    {% for message in form_client.raison.errors %}
                                                        <div class="uk-alert uk-alert-danger">{{ message }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.name.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_client.name(class_='uk-input required') }}
                                                    {% for message in form_client.name.errors %}
                                                        <div class="uk-alert uk-alert-danger">{{ message }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.email.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_client.email(class_='uk-input required') }}
                                                    {% for message in form_client.email.errors %}
                                                        <div class="uk-alert uk-alert-danger">{{ message }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.phone.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_client.phone(class_='uk-input') }}
                                                    {% for message in form_client.phone.errors %}
                                                        <div class="uk-alert uk-alert-danger">{{ message }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.ville.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_client.ville(class_='uk-input required') }}
                                                    {% for message in form_client.ville.errors %}
                                                        <div class="uk-alert uk-alert-danger">{{ message }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_client.quartier.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_client.quartier(class_='uk-input required') }}
                                                    {% for message in form_client.quartier.errors %}
                                                        <div class="uk-alert uk-alert-danger">{{ message }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>

                                    {% endif %}

                                    </div>

                                </div>
                                <div class="uk-width-1-2@s">
                                    <div class="uk-grid-small" uk-grid>
                                        <div class="uk-width-1-1@s">
                                            <h3 class="uk-heading-line uk-text-center"><span>Information contact</span></h3>
                                        </div>
                                            <div class="uk-width-1-1@s">
                                                <div class="uk-margin">
                                                    <label for="" class="uk-form-label"></label>
                                                    <div class="uk-form-controls">
                                                        <select  name="contact_exist" id="contact_exist" class="uk-select selected">
                                                            <option value="">Selectionnez un contact existant</option>
                                                            {% for contact in contact_list %}
                                                                <option value="{{ contact.id }}" {% if form_contact.id.data|string == contact.id|string %} selected {% endif %}>{{ contact.full_name() }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_contact.last_name.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_contact.last_name(class_='uk-input required') }}
                                                    {% for message in form_contact.last_name.errors %}
                                                        <div class="uk-alert uk-alert-danger">{{ message }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_contact.first_name.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_contact.first_name(class_='uk-input required') }}
                                                    {% for message in form_contact.first_name.errors %}
                                                        <div class="uk-alert uk-alert-danger">{{ message }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_contact.email.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_contact.email(class_='uk-input required') }}
                                                    {% for message in form_contact.email.errors %}
                                                        <div class="uk-alert uk-alert-danger">{{ message }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_contact.phone.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_contact.phone(class_='uk-input') }}
                                                    {% for message in form_contact.phone.errors %}
                                                        <div class="uk-alert uk-alert-danger">{{ message }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="uk-width-1-2@s">
                                            <div class="uk-margin">
                                                {{ form_contact.fonction.label(class_='uk-form-label uk-text-bold') }}
                                                <div class="uk-form-controls">
                                                    {{ form_contact.fonction(class_='uk-input') }}
                                                    {% for message in form_contact.fonction.errors %}
                                                        <div class="uk-alert uk-alert-danger">{{ message }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                             <div class=" uk-clearfix uk-width-1-1">
                                <hr class="uk-divider-icon"/>
                                <ul uk-tab>
                                    <li><a href="#">Produits de la commande</a></li>
                                </ul>

                                <ul class="uk-switcher uk-margin">
                                    <li>
                                        {% if not form.devis_id.data %}
                                            <a href="" class="uk-button waves-effect uk-button-success uk-button-small uk-margin" id="addRow"><span class="uk-margin-small-right"><i class="fa fa-plus"></i></span> produit</a>
                                        {% endif %}

                                        <div class="uk-overflow-auto">
                                            <input type="hidden" name="ici_cm" id="ici_cm" value="{{ session.get('package')['exist_ici']|string }}">
                                            <table class="uk-table uk-table-small uk-table-middle" id="dataTable_produit">
                                                <thead>
                                                    <tr>
                                                        <th width="20%">Service</th>
                                                        <th width="20%">Produit</th>
                                                        <th width="16%">Quantite</th>
                                                        <th width="16%">Prix unitaires</th>
                                                        <th width="16%">Sous total</th>
                                                        <th width="7%" class="no-sort"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                {% if form.devis_id.data or data.parent %}
                                                    {% for pack in ligne_doc %}
                                                        <tr>
                                                            <td>
                                                                <div class="uk-form-controls uk-form-service">

                                                                    <ul class="uk-subnav uk-margin-remove-bottom">
                                                                        {% for service in services %}
                                                                            {% if service.sigle == pack.idpackage.idligneService %}
                                                                                <li class="uk-active">{{ service.name }}</li>
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                    </ul>

                                                                </div>
                                                            </td>
                                                            <td>

                                                                <div class="uk-form-controls uk-form-package">

                                                                    <ul class="uk-subnav uk-margin-remove-bottom">
                                                                        <li class="uk-active">{{ pack.idpackage.name }}</li>
                                                                    </ul>

                                                                </div>

                                                            </td>
                                                            <td>
                                                                <div class="uk-form-controls uk-form-qte">

                                                                    <input type="text" value="{{ pack.qte }}" name="qte" class="uk-input change_qte uk-width-auto uk-form-blank"/>

                                                                </div>
                                                            </td>
                                                            <td>
                                                                <div class="uk-form-controls uk-form-prix">
                                                                    <div class="uk-width-auto">{{ (pack.prix / pack.qte)|round(2, 'floor') }}</div>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <div class="uk-form-controls uk-form-st">
                                                                    <input type="text" value="{{ pack.prix }}" name="st" class="uk-input change_st uk-width-auto uk-form-blank">
                                                                </div>
                                                            </td>
                                                            <td></td>
                                                        </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    {% for pack in session.get('package_fact')['data'] %}
                                                        <tr>
                                                            <td>
                                                                <div class="uk-form-controls uk-form-service">

                                                                    <select name="services"  class="uk-select selected services">
                                                                        <option value="">Choisir un service</option>
                                                                        {% for service in services %}
                                                                            <option value="{{ service.sigle }}" {% if pack['service'] == service.sigle %} selected {% endif %}>{{ service.name }}</option>
                                                                        {% endfor %}
                                                                    </select>

                                                                </div>
                                                            </td>
                                                            <td>

                                                                <div class="uk-form-controls uk-form-package">

                                                                    <select name="package" class="uk-select selected package">
                                                                        <option value="">Choisir un produit</option>
                                                                        {% for package in pack['similaire'] %}
                                                                            <option value="{{ package.id }}" {% if pack['package']|string == package.id|string %} selected {% endif %}>{{ package.name }}</option>
                                                                        {% endfor %}
                                                                    </select>

                                                                </div>

                                                            </td>
                                                            <td>
                                                                <div class="uk-form-controls uk-form-qte">

                                                                    <a class="uk-button uk-button-link uk-button-small uk-text-small ddd uk-icon-link" href="#" data-multi="-1"><span uk-icon="icon: minus"></span></a>

                                                                    <input type="text" value="{{ pack['qte'] }}" name="qte" class="uk-input change_qte uk-width-auto uk-text-center"/>

                                                                    <a class="uk-button uk-button-link uk-button-small uk-text-small ddd uk-icon-link" href="#" data-multi="1"><span uk-icon="icon: plus"></span></a>

                                                                </div>
                                                            </td>
                                                            <td>
                                                                <div class="uk-form-controls uk-form-prix">
                                                                    <div class="uk-width-auto uk-text-center" data-old="{{ pack['prix'] }}">{{ pack['prix']|round(2, 'floor') }}</div>
                                                                    <input type="hidden" value="{{ pack['prix'] }}" name="prix" class="change_prix"/>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <div class="uk-form-controls uk-form-st">
                                                                    <input type="text" value="{{ pack['st'] }}" name="st" class="uk-input change_st uk-width-auto uk-text-center" data-old="{{ pack['st'] }}">
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <a href="" class="uk-button uk-button-default uk-button-small delete_item" ><span uk-icon="icon: trash"></span></a>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                {% endif %}
                                                </tbody>

                                            </table>
                                            <hr/>

                                        </div>
                                        <div class="uk-float-right uk-width-2-5@s">
                                            <table class="uk-table uk-table-small uk-table-middle">
                                                <tbody>
                                                <tr>
                                                    <td><strong>Montant HT</strong></td>
                                                    <td class="uk-text-right" id="global_total">0</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Taxes</strong> (<span id="taxe_tva">0</span>%)</td>
                                                    <td class="uk-text-right" id="tva_value">0</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Total</strong></td>
                                                    <td class="uk-text-right" id="total_ttc">0</td>
                                                </tr>
                                                </tbody>

                                            </table>
                                        </div>
                                    </li>
                                </ul>
                            </div>

                        </div>
                    </form>
                </div>

            </div>
    </div>
{% endblock %}

{% block footer_script %}

     <script>

        var $ici_cm = $('input#ici_cm').val();

        var table_produit = $('#dataTable_produit').DataTable({
            'language':{
                "sProcessing":     "Traitement en cours...",
                "sSearch":         "Rechercher&nbsp;:",
                "sLengthMenu":     "Afficher _MENU_ &eacute;l&eacute;ments",
                "sInfo":           "Affichage de  _START_ &agrave; _END_ sur _TOTAL_ ",
                "sInfoEmpty":      "Affichage de 0 &agrave; 0 sur 0 ",
                "sInfoFiltered":   "(filtr&eacute; de _MAX_ &eacute;l&eacute;ments au total)",
                "sInfoPostFix":    "",
                "sLoadingRecords": "Chargement en cours...",
                "sZeroRecords":    "Aucun &eacute;l&eacute;ment &agrave; afficher",
                "sEmptyTable":     "Aucune donn&eacute;e disponible",
                "oPaginate": {
                    "sFirst":      "Premier",
                    "sPrevious":   "Pr&eacute;c&eacute;dent",
                    "sNext":       "Suivant",
                    "sLast":       "Dernier"
                },
                "oAria": {
                    "sSortAscending":  ": activer pour trier la colonne par ordre croissant",
                    "sSortDescending": ": activer pour trier la colonne par ordre d&eacute;croissant"
                }
            },
            "info": false,
            "searching": false,
            "iDisplayLength": -1,
            "paging": false,
            "scrollY": "500px",
            "scrollCollapse": true,
            //dom: 'f',
            "bLengthChange" : false
        });

        var counter = table_produit.rows().count() ;

        $('#submit').on('click', function(e){
            e.preventDefault();
            if(counter >= 1){
                $('#formulaire').submit();
            }
        });

        $('#submit_nouveau').on('click', function(e){
            $('#nouveau').val(1);
            e.preventDefault();
            if(counter >= 1){
                $('#formulaire').submit();
            }
        });


        {% if ('contact_exist' in request.form and request.form['contact_exist']) or form_contact.id.data %}

            $('#first_name').addClass('uk-form-blank').removeClass('required');
            $('#last_name').addClass('uk-form-blank').removeClass('required');
            $('#email').addClass('uk-form-blank').removeClass('required');
            $('#phone').addClass('uk-form-blank');
            $('#fonction').addClass('uk-form-blank');

        {% endif %}

        {% if ('client_exist' in request.form and request.form['client_exist']) or form_client.id.data %}

            $('#client-name').addClass('uk-form-blank').removeClass('required');
            $('#client-email').addClass('uk-form-blank').removeClass('required');
            $('#client-phone').addClass('uk-form-blank');
            $('#client-ville').addClass('uk-form-blank').removeClass('required');
            $('#client-quartier').addClass('uk-form-blank').removeClass('required');
            $('#client-raison').addClass('uk-form-blank');

        {% endif %}


        $('#client_exist').on('change', function(e){
            e.preventDefault();

            var client_exist = $('#client_exist').val();
            if(client_exist != ''){
                var datas = {};
                datas['client'] = String(client_exist);
                var url = '{{ url_for('client.find_customer') }}';
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify(datas),
                    contentType: 'application/json;charset=UTF-8',
                    dataType: "json",
                    success: function(data) {
                        if(data['statut'] === 'OK'){
                            $('#client-id').val(data['id']);
                            $('#client-name').val(data['name']).addClass('uk-form-blank').removeClass('required');
                            $('#client-email').val(data['email']).addClass('uk-form-blank').removeClass('required');
                            $('#client-phone').val(data['phone']).addClass('uk-form-blank');
                            $('#client-ville').val(data['ville']).addClass('uk-form-blank').removeClass('required');
                            $('#client-quartier').val(data['quartier']).addClass('uk-form-blank').removeClass('required');
                            $('#client-raison').val(data['raison']).addClass('uk-form-blank').change();
                            $('.to-hide').hide()

                        }
                    }
                });

                var url_2 = '{{ url_for('client.find_contact') }}';
                $.ajax({
                    url: url_2,
                    type: 'POST',
                    data: JSON.stringify(datas),
                    contentType: 'application/json;charset=UTF-8',
                    dataType: "json",
                    success: function(data) {
                        $('#contact_exist option:gt(0)').remove();
                        $.each(data['data'], function(index, value) {
                            $("#contact_exist").append('<option value="'+ value['id'] +'">'+ value['first_name'] +' '+value['last_name']+' '+value['fonction']+'</option>');
                        });
                    }
                });


            }else{
                $('#client-id').val('');
                $('#client-name').val('').removeClass('uk-form-blank').addClass('required');
                $('#client-email').val('').removeClass('uk-form-blank').addClass('required');
                $('#client-phone').val('').removeClass('uk-form-blank');
                $('#client-ville').val('').removeClass('uk-form-blank').addClass('required');
                $('#client-quartier').val('').removeClass('uk-form-blank').addClass('required');
                $('#client-raison').val('').removeClass('uk-form-blank');
                $('.to-hide').show();
                $('#contact_exist option:gt(0)').remove();
            }
        });




        $('#contact_exist').on('change', function(e){
            e.preventDefault();

            var client_exist = $('#contact_exist').val();
            if(client_exist != '') {
                var datas = {};
                datas['contact'] = String(client_exist);
                var url = '{{ url_for('client.find_single_contact') }}';
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify(datas),
                    contentType: 'application/json;charset=UTF-8',
                    dataType: "json",
                    success: function (data) {
                        if (data['statut'] === 'OK') {
                            $('#id').val(data['id']);
                            $('#first_name').val(data['first_name']).addClass('uk-form-blank').removeClass('required');
                            $('#last_name').val(data['last_name']).addClass('uk-form-blank').removeClass('required');
                            $('#email').val(data['email']).addClass('uk-form-blank').removeClass('required');
                            $('#phone').val(data['mobile']).addClass('uk-form-blank');
                            $('#fonction').val(data['fonction']).addClass('uk-form-blank');

                        }
                    }
                });
            }else{
                $('#id').val('');
                $('#first_name').val('').removeClass('uk-form-blank').addClass('required');
                $('#last_name').val('').removeClass('uk-form-blank').addClass('required');
                $('#email').val('').removeClass('uk-form-blank').addClass('required');
                $('#phone').val('').removeClass('uk-form-blank');
                $('#fonction').val('').removeClass('uk-form-blank');
            }
        });

        $('#addRow').on( 'click', function (e) {
            e.preventDefault();

            $select = $('<div/>').append(
                $('<div/>').addClass('uk-form-controls uk-form-service').append(
                    $('<select/>').addClass('uk-select selected services').attr({
                        name: 'services'
                    }).append(
                        $('<option value="">Choisir un service</option>'),
                        {% for service in services %}
                            $('<option value="{{ service.sigle }}">{{ service.name }}</option>'),
                        {% endfor %}
                    )
                )
            );

            $select_pack = $('<div/>').append(
                $('<div/>').addClass('uk-form-controls uk-form-package').append(
                    $('<select/>').addClass('uk-select selected package').attr({
                        name: 'package'
                    }).append(
                        $('<option value="">Choisir un produit</option>')
                    )
                )
            );

            $input_qte = $('<div/>').append(
                $('<div/>').addClass('uk-form-controls uk-form-qte').append(
                    $('<a class="uk-button uk-button-link uk-button-small uk-text-small ddd uk-icon-link" href="#" data-multi="-1"><span uk-icon="icon: minus"></span></a>'),
                    $('<input type="text" value="1" name="qte" class="uk-input change_qte uk-width-auto uk-text-center"/>'),
                    $('<a class="uk-button uk-button-link uk-button-small uk-text-small ddd uk-icon-link" href="#" data-multi="1"><span uk-icon="icon: plus"></span></a>')
                )
            );

            $unit_price = $('<div/>').append(
                $('<div/>').addClass('uk-form-controls uk-form-prix').append(
                    $('<div class="uk-width-auto uk-text-center">0</div>').attr(
                        {
                            "data-old": 0
                        }
                    ),
                    $('<input type="hidden" value="0" name="prix" class="change_prix"/>')

                )
            );

            $input_st = $('<div/>').append(
                $('<div/>').addClass('uk-form-controls uk-form-st').append(
                    $('<input type="text" value="0" name="st" class="uk-input change_st uk-width-auto uk-text-center"/>').attr(
                        {
                            "data-old": 0
                        }
                    )

                )
            );

            table_produit.row.add( [
                $select.html(),
                $select_pack.html(),
                $input_qte.html(),
                $unit_price.html(),
                $input_st.html(),
                '<a href="" class="uk-button uk-button-default uk-button-small delete_item" ><span uk-icon="icon: trash"></span></a>'
            ] ).draw( false );

            $(".selected").select2({width:'100%'});



            verif_ici_cm();
            counter = table_produit.rows().count();
        } );

        $('body').on( 'click', '.delete_item', function (e) {
            e.preventDefault();

            verif_ici_cm();

            $tr = $(this).parent().parent();
            table_produit.row($tr).remove().draw( false );
            change_total();
            save_ligne_doc();
            counter = table_produit.rows().count();
        } );


        $('body').on('change', '.services', function(e){
            e.preventDefault();
            var $this = $(this);
            var datas = {};

            $ici_cm = $('input#ici_cm').val();

            $package = $this.parent().parent().next().find('.package');
            datas['service'] = $this.val();

            if($this.val() != '') {

                if($this.val() == 'ici_cm' && $ici_cm){
                    $package.find('option:gt(0)').remove();
                    $text = 'Cette ligne de service n\'est utilisable qu\'une seule fois.';
                    UIkit.modal.alert($text).then(function() {
                    });
                }else{
                    var url = '{{ url_for('package.find_package') }}';
                    $.ajax({
                        url: url,
                        type: 'POST',
                        data: JSON.stringify(datas),
                        contentType: 'application/json;charset=UTF-8',
                        dataType: "json",
                        success: function (data) {
                            if (data['statut'] === 'OK') {

                                $package.find('option:gt(0)').remove();
                                $.each(data['data'], function (index, value) {
                                    $package.append('<option value="' + value['id'] + '">' + value['name'] + '</option>');
                                });

                            }
                        }
                    });
                }


            }else{
                $package.find('option:gt(0)').remove();
                $package.change();
            }

            verif_ici_cm();

        });

        $('body').on('change', '.package', function(e) {
            e.preventDefault();

            var $this = $(this);
            $qte = $this.parent().parent().next().find('.change_qte');
            $prix = $this.parent().parent().next().next().find('.uk-form-prix > div');
            $prix_hidden = $this.parent().parent().next().next().find('.uk-form-prix > .change_prix');
            $sous_total = $this.parent().parent().next().next().next().find('.change_st');

            var datas = {};
            datas['package'] = $this.val();

            if($this.val() != '') {
                var url = '{{ url_for('package.find_single_package') }}';
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify(datas),
                    contentType: 'application/json;charset=UTF-8',
                    dataType: "json",
                    success: function (data) {
                        if (data['statut'] === 'OK') {

                            $qte.val(data['qte']);

                            prix = parseFloat(data['prix']) / parseFloat(data['qte']);

                            $prix.html(prix.toFixed(2)).data("old", prix);
                            $prix_hidden.val(prix);


                            $sous_total.val(parseFloat(data['prix']).toFixed(2)).data("old", parseFloat(data['prix']));

                            change_total();


                            save_ligne_doc();

                        }
                    }
                });

            }else{
                $qte.val(1);
                $prix.html(0).data("old", 0);
                $prix_hidden.val(0);
                $sous_total.val(0).data("old", 0);


                save_ligne_doc();

            }



        });

        change_total();
{#        verif_ici_cm();#}

        $("body").on("click", ".ddd", function (e) {
            e.preventDefault();

            var $button = $(this);
            var $inline = $button.closest('.uk-form-qte');
            var $input = $button.closest('.uk-form-qte').find("input.change_qte");

            $sous_total = $inline.parent().next().next().find('.change_st');
            $prix = $inline.parent().next().find('.uk-form-prix > div');

            $input.val(function(i, value) {
                return +value + (1 * +$button.data('multi'));
            });

            if(parseInt($input.val()) < 1){
                $input.val(1);
            }
            new_sous_total = parseFloat($prix.data('old')) * parseFloat($input.val());
            $sous_total.val(new_sous_total.toFixed(2)).data("old", new_sous_total);


            change_total();
            save_ligne_doc();
        });


        $('body').on('change', '#dataTable_produit tbody .change_qte', function(e){

            e.preventDefault();

            $sous_total = $(this).parent().parent().next().next().find('.change_st');

            $prix = $(this).parent().parent().next().find('.uk-form-prix > div');

            if(parseInt($(this).val()) < 1){
                $(this).val(1)
            }

            new_sous_total = parseFloat($prix.data('old')) * parseFloat($(this).val());
            $sous_total.val(new_sous_total.toFixed(2)).data("old", new_sous_total);

            change_total();
            save_ligne_doc();

        });

        $('body').on('change', '#dataTable_produit tbody .change_st', function(e){

            e.preventDefault();

            $qte = $(this).parent().parent().prev().prev().find('.change_qte');



            $prix = $(this).parent().parent().prev().find('.uk-form-prix > div');
            $prix_hidden = $(this).parent().parent().prev().find('.uk-form-prix > .change_prix');

            if(parseInt($(this).val()) < 1){
                $(this).val($(this).data('old'))
            }

            new_prix = parseFloat($(this).val()) / parseFloat($qte.val());
            $prix.html(new_prix.toFixed(2)).data("old", new_prix);
            $prix_hidden.val(new_prix);


            change_total();
            save_ligne_doc();

        });

        function reload_count(){
            $(".change_qte").each(function(){
                console.log($(this))
            });
        }

{#        $('#apply_tva:checkbox').change(function() {#}
{#            $tva_value = '{{ current_ref.taux_tva }}';#}
{#            if($('#apply_tva').prop('checked')){#}
{#                $('#taxe_tva').text($tva_value);#}
{#            }else{#}
{#                $('#taxe_tva').text('0');#}
{#            }#}
{#            change_total();#}
{#        });#}


        function concat($value){
            $int = $value.split(" ");

            var $values = '';
            $.each($int, function(index, value){
                $values = $values + value;
            });

            return $values;
        }

        function change_total(){

{#         $('.uk-form-qte').each(function(){#}
{#            $prix = $(this).parent().next().find('.prix').val();#}
{#            $input = $(this).find(".change_qte");#}
{#            $total = parseInt($input.val()) * parseFloat($prix);#}
{#            $all = $(this).parent().next().next().find('.change_total').text($total);#}
{#         })#}


{#         $tva_value = '{{ current_ref.taux_tva }}';#}
{#         if($('#apply_tva').prop('checked')){#}
{#            $('#taxe_tva').text($tva_value);#}
{#         }else{#}
{#            $('#taxe_tva').text('0');#}
{#         }#}

             total = 0;

             $('#dataTable_produit tbody .change_st').each(function(){
                 total = total + parseFloat($(this).val());
             });

             $('#global_total').text(total);

             $tva = parseFloat($('#taxe_tva').text());
             $tva_result = ($tva * total) / 100;

             $('#tva_value').text($tva_result);

             $ttc = $tva_result + total;
             $('#total_ttc').text($ttc);

             $('#global_total, #tva_value, #total_ttc').formatCurrency({
                symbol: '',
                positiveFormat: '%s%n',
                negativeFormat: '(%s%n)',
                decimalSymbol: ',',
                digitGroupSymbol: ' ',
                groupDigits: true
             });



        }

        function verif_ici_cm(){

            counters = 0;
            $('#dataTable_produit tbody .services').each(function(){
                if($(this).val() == 'ici_cm'){
                    counters++;
                }
            });

            if(counters > 0){
                $('#ici_cm').val(1)
            }else{
                $('#ici_cm').val('')
            }

{#            console.log($('#ici_cm').val());#}

        }

        function save_ligne_doc(){
            var datas = table_produit.$('input, select').serialize();

            var url = '{{ url_for('facture.ligne_commande') }}';
            $.ajax({
                method: "POST",
                data: datas,
                url: url
            }).done(function( msg ) {

                msg = $.parseJSON(msg);
                console.log(msg);


            })

        }

{#        $('body').on('click', '.delete_item', function(e){#}
{#        e.preventDefault();#}
{#        var url = $(this).attr('href');#}
{#        $.ajax({#}
{#            url: url,#}
{#            dataType: "json",#}
{#            success: function(data) {#}
{#                if(data['statut'] === 'OK') {#}
{#                    if( data['data'].length != 0){#}
{##}
{#                        $("#reload_site tbody").empty();#}
{##}
{#                        var url = "{{ url_for('devis.delete_item') }}";#}
{#                        var url_pack = "{{ url_for('devis.add_site') }}";#}
{##}
{#                        $.each(data['data'], function(index, value) {#}
{#                            url_pack = url_pack+'?package='+value['id'];#}
{#                            $pack = $('<tr/>').addClass('uk-background-blue-grey').append(#}
{#                                $('<td/>').attr('colspan', 3).append(#}
{#                                    value['name']+' x '+value['qte']+' = <span id="passage_total" data-id="'+value['id']+'">'+value['total']+'</span> Passages ',#}
{#                                    '<button type="button" class="uk-button uk-button-default uk-button-small uk-display-block uk-float-right add_pack" data-id="'+value['id']+'"><span class="uk-margin-small-right"><i class="fa fa-plus"></i></span> sites</button>'#}
{#                                ),#}
{#                                $('<td/>').html('<div class="uk-text-uppercase uk-hidden uk-text-center"><span id="reste-pack" class="uk-text-bold uk-margin-small-right" data-pack="'+value['id']+'">0</span> Passage(s)</div>'),#}
{#                                $('<td/>').html('<a href="'+url+''+index+'" class="uk-button uk-button-default uk-button-small delete_item" ><span uk-icon="icon: trash"></span></a>')#}
{#                            );#}
{#                            $("body #reload_site tbody").append($pack);#}
{#                            var $nbr_ville = value['ville'].length;#}
{#                            $.each(value['ville'], function(index_ville, value_ville) {#}
{##}
{#                                $.each(value_ville['site'], function(index_site, value_site) {#}
{##}
{#                                    $select = $('<input/>').addClass('uk-input change_qte uk-width-auto uk-text-center').attr(#}
{#                                        {#}
{#                                            name:'qte',#}
{#                                            value:value_site['qte'],#}
{#                                            "data-nbre":$nbr_ville,#}
{#                                            "data-ville":value_ville['id'],#}
{#                                            "data-position": index_site,#}
{#                                            "data-pack":value['id']#}
{##}
{#                                        }#}
{#                                    );#}
{##}
{#                                    $ligne = $('<tr/>').append(#}
{#                                        $('<td/>').html(value_site['ref']+' <br/>'+value_site['name']+'<input type="hidden" value="'+ value_site['id'] +'" name="id"/>'),#}
{#                                        $('<td/>').append(#}
{#                                            $('<div/>').addClass('uk-form-controls uk-form-qte').append(#}
{#                                                '<a class="uk-button uk-button-link uk-button-small uk-text-small ddd uk-icon-link" href="#" data-multi="-1"><span uk-icon="icon: minus"></span></a>',#}
{#                                                $select,#}
{#                                                '<a class="uk-button uk-button-link uk-button-small uk-text-small ddd uk-icon-link" href="#" data-multi="1"><span uk-icon="icon: plus"></span></a>'#}
{#                                            )#}
{#                                        ),#}
{#                                        $('<td/>').html(#}
{#                                            '<input type="text" value="'+value_site['prix']+'" class="uk-input uk-form-blank prix" name="prix"/>'#}
{#                                        ),#}
{#                                        $('<td/>').html('<div class="utotal change_total">'+value_site['total']+'</div>'),#}
{#                                        $('<td/>').html('<a href="'+url+''+index+'/'+index_ville+'/'+index_site+'" class="uk-button uk-button-default uk-button-small delete_item" ><span uk-icon="icon: trash"></span></a>')#}
{##}
{#                                    );#}
{#                                    $("body #reload_site tbody").append($ligne);#}
{##}
{##}
{##}
{#                                });#}
{##}
{#                            });#}
{#                        });#}
{##}
{#                    }else{#}
{#                        $("#reload_site tbody").empty().append('<tr><td colspan="6"> <h3 class="uk-text-center">Ajouter des sites</h3> </td></tr>');#}
{#                    }#}
{#                    change_total();#}
{#                }#}
{#            }#}
{#        });#}
{#    });#}

    </script>

{% endblock %}